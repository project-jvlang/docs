name: Security Scan

on:
  pull_request:
    branches:
      - main
      - master
  push:
    branches:
      - main
      - master

jobs:
  scan:
    runs-on: ubuntu-latest
    name: Scan for sensitive information

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Scan for local paths
        id: local-paths
        run: |
          echo "Scanning for local filesystem paths..."
          FOUND=0

          # Local user paths
          if grep -rn --include="*.md" --include="*.yml" --include="*.yaml" --include="*.json" --include="*.toml" \
            -E '/home/[^/]+/|/Users/[^/]+/|C:\\Users\\' . 2>/dev/null | grep -v '.git/'; then
            echo "::warning::Local user paths detected"
            FOUND=1
          fi

          # Temp paths
          if grep -rn --include="*.md" --include="*.yml" --include="*.yaml" --include="*.json" --include="*.toml" \
            -E '/tmp/|/var/tmp/' . 2>/dev/null | grep -v '.git/'; then
            echo "::warning::Temporary paths detected"
            FOUND=1
          fi

          echo "found=$FOUND" >> $GITHUB_OUTPUT

      - name: Scan for private IPs
        id: private-ips
        run: |
          echo "Scanning for private IP addresses..."
          FOUND=0

          if grep -rn --include="*.md" --include="*.yml" --include="*.yaml" --include="*.json" --include="*.toml" \
            -E '192\.168\.[0-9]+\.[0-9]+|10\.[0-9]+\.[0-9]+\.[0-9]+|172\.(1[6-9]|2[0-9]|3[0-1])\.[0-9]+\.[0-9]+' . 2>/dev/null | grep -v '.git/'; then
            echo "::warning::Private IP addresses detected"
            FOUND=1
          fi

          echo "found=$FOUND" >> $GITHUB_OUTPUT

      - name: Scan for API keys
        id: api-keys
        run: |
          echo "Scanning for API keys and tokens..."
          FOUND=0

          # Common API key patterns
          PATTERNS=(
            'sk-[a-zA-Z0-9]{32,}'
            'ghp_[a-zA-Z0-9]{36}'
            'ghs_[a-zA-Z0-9]{36}'
            'github_pat_[a-zA-Z0-9_]{22,}'
            'xox[baprs]-[a-zA-Z0-9-]+'
            'AKIA[A-Z0-9]{16}'
          )

          for pattern in "${PATTERNS[@]}"; do
            if grep -rn --include="*.md" --include="*.yml" --include="*.yaml" --include="*.json" --include="*.toml" \
              -E "$pattern" . 2>/dev/null | grep -v '.git/'; then
              echo "::error::API key or token detected!"
              FOUND=1
            fi
          done

          echo "found=$FOUND" >> $GITHUB_OUTPUT

      - name: Scan for credentials
        id: credentials
        run: |
          echo "Scanning for hardcoded credentials..."
          FOUND=0

          # Password patterns
          if grep -rn --include="*.md" --include="*.yml" --include="*.yaml" --include="*.json" --include="*.toml" \
            -iE 'password\s*[=:]\s*["\047][^"\047]+["\047]|secret\s*[=:]\s*["\047][^"\047]+["\047]' . 2>/dev/null | grep -v '.git/' | grep -v 'example' | grep -v 'placeholder'; then
            echo "::error::Hardcoded credentials detected!"
            FOUND=1
          fi

          echo "found=$FOUND" >> $GITHUB_OUTPUT

      - name: Check for sensitive files
        id: sensitive-files
        run: |
          echo "Checking for sensitive files..."
          FOUND=0

          SENSITIVE_PATTERNS=(
            ".env"
            ".env.*"
            "*.pem"
            "*.key"
            "*.p12"
            "*.pfx"
            "id_rsa*"
            "id_ed25519*"
            "credentials.*"
            "secrets.*"
          )

          for pattern in "${SENSITIVE_PATTERNS[@]}"; do
            if find . -name "$pattern" -not -path './.git/*' 2>/dev/null | grep -q .; then
              echo "::error::Sensitive file detected: $pattern"
              find . -name "$pattern" -not -path './.git/*'
              FOUND=1
            fi
          done

          echo "found=$FOUND" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.local-paths.outputs.found }}" == "1" ]; then
            echo "- :warning: Local paths detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "- :white_check_mark: No local paths" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.private-ips.outputs.found }}" == "1" ]; then
            echo "- :warning: Private IPs detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "- :white_check_mark: No private IPs" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.api-keys.outputs.found }}" == "1" ]; then
            echo "- :x: API keys detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "- :white_check_mark: No API keys" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.credentials.outputs.found }}" == "1" ]; then
            echo "- :x: Credentials detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "- :white_check_mark: No credentials" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.sensitive-files.outputs.found }}" == "1" ]; then
            echo "- :x: Sensitive files detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "- :white_check_mark: No sensitive files" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail on critical findings
        if: steps.api-keys.outputs.found == '1' || steps.credentials.outputs.found == '1' || steps.sensitive-files.outputs.found == '1'
        run: |
          echo "::error::Critical security issues found. Please review and fix before merging."
          exit 1
